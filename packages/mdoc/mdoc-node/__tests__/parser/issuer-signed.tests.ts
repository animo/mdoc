import type { MDoc } from '@protokoll/mdoc-client';
import { parse } from '@protokoll/mdoc-client';
import { hex } from 'buffer-tag';

describe('parse an issuer signed mdoc', () => {
  let parsed: MDoc;

  beforeAll(() => {
    const mdoc = hex`a36776657273696f6e63312e3069646f63756d656e747381a267646f6354797065756f72672e69736f2e31383031332e352e312e6d444c6c6973737565725369676e6564a26a6e616d65537061636573a26f6f72672e637573746f6d2e7465737481d818585bb90004686469676573744944006672616e646f6d5820966ca23f9523c3c085c19da467221e98f357dc499843f95a87f83e2d4b394d9e71656c656d656e744964656e74696669657264636f6f6c6c656c656d656e7456616c7565f5716f72672e69736f2e31383031332e352e318ed8185867b90004686469676573744944006672616e646f6d5820e20827abe5f1d4d33a15c31c2a469e1dbb6950b60a7bd042587e9f189a4e4ce571656c656d656e744964656e7469666965726b66616d696c795f6e616d656c656c656d656e7456616c756565536d697468d8185865b90004686469676573744944016672616e646f6d5820974b01204b62a16a5878d4100fb988f10afd00f9f4fe8e42fbe2acb0f882f40f71656c656d656e744964656e7469666965726a676976656e5f6e616d656c656c656d656e7456616c7565644a6f686ed818586eb90004686469676573744944026672616e646f6d5820f9005be7afe8e5556ad2ad66bf1b03d6b79c394223eb990782db2bf9ac5f803f71656c656d656e744964656e7469666965726a62697274685f646174656c656c656d656e7456616c7565d903ec6a313938302d30362d3135d8185862b90004686469676573744944036672616e646f6d5820f62a463b617cf5939bdc1a6d067af7e2207a982aeb6f3523930bc501a07f841571656c656d656e744964656e7469666965726b6167655f6f7665725f32316c656c656d656e7456616c7565f5d8185862b90004686469676573744944046672616e646f6d5820cfc02bff03aa2dc7e8e029f4f4a51f78329053e89af968434807d029c31e625671656c656d656e744964656e7469666965726b6167655f6f7665725f34336c656c656d656e7456616c7565f5d818586eb90004686469676573744944056672616e646f6d5820e626ff8c159690c89ba1b69d5e96b63a644324298169d9d1b3e9bf00c37a7e2671656c656d656e744964656e7469666965726a69737375655f646174656c656c656d656e7456616c7565d903ec6a323032332d30332d3031d818586fb90004686469676573744944066672616e646f6d5820c0ccd83efce6b8d247a9fb430fce033896713441b7884320e9badba37d18795471656c656d656e744964656e7469666965726b6578706972795f646174656c656c656d656e7456616c7565d903ec6a323032382d30332d3331d8185868b90004686469676573744944076672616e646f6d5820fc420e24beae5c05378985840749b7453944b23f9c5a894fe1b5f4ffbeea5c2e71656c656d656e744964656e7469666965726f69737375696e675f636f756e7472796c656c656d656e7456616c7565625553d818586eb90004686469676573744944086672616e646f6d5820a4690fd8cf423a15377b37008c69d420003924c8f7783cdb8936eb4456c6e52671656c656d656e744964656e7469666965727169737375696e675f617574686f726974796c656c656d656e7456616c7565664e5920444d56d8185873b90004686469676573744944096672616e646f6d58200fb56a89a94d9eef9bc5017c6e59a33ba4ca194d8b79d4bb12ef6b77e5792dcd71656c656d656e744964656e7469666965727469737375696e675f6a7572697364696374696f6e6c656c656d656e7456616c7565684e657720596f726bd8185871b900046864696765737449440a6672616e646f6d582075da3a6d87f2232fa400b5cdd2f90092490fa193b8fcf67713d7f7f205eac12971656c656d656e744964656e7469666965726f646f63756d656e745f6e756d6265726c656c656d656e7456616c75656b30312d3333332d37303730d8185863b900046864696765737449440b6672616e646f6d58206d909cc8859fe746e4ee03ef6eac7d2c41b40245fb79ff9cb8b637ed46adee7971656c656d656e744964656e74696669657268706f7274726169746c656c656d656e7456616c75656462737472d81858b1b900046864696765737449440c6672616e646f6d5820f80cdeed9a991f24eb4f5e75f5d327980f812ed67f0eaf94676b40cf9845298671656c656d656e744964656e7469666965727264726976696e675f70726976696c656765736c656c656d656e7456616c756581b900037576656869636c655f63617465676f72795f636f646561436a69737375655f646174656a323032332d30332d30316b6578706972795f646174656a323032382d30332d3331d818587ab900046864696765737449440d6672616e646f6d5820cf2c1e264bc4446761537c17d52b0024fc8ee5d1d30114d623c252559fbc5eb471656c656d656e744964656e74696669657276756e5f64697374696e6775697368696e675f7369676e6c656c656d656e7456616c75656d7462642d75732e6e792e646d766a697373756572417574688443a10126a20442313118218159022e3082022a308201d0a003020102021457c6ccd308bde43eca3744f2a87138dabbb884e8300a06082a8648ce3d0403023053310b30090603550406130255533111300f06035504080c084e657720596f726b310f300d06035504070c06416c62616e79310f300d060355040a0c064e5920444d56310f300d060355040b0c064e5920444d56301e170d3233303931343134353531385a170d3333303931313134353531385a3053310b30090603550406130255533111300f06035504080c084e657720596f726b310f300d06035504070c06416c62616e79310f300d060355040a0c064e5920444d56310f300d060355040b0c064e5920444d563059301306072a8648ce3d020106082a8648ce3d03010703420004893c2d8347906dc6cd69b7f636af4bfd533f96184f0aadacd10830da4471dbdb60ac170d1cfc534fae2d9dcd488f7747fdf978d925ea31e9e9083c382ba9ed53a38181307f301d0603551d0e04160414ab6d2e03b91d492240338fbccadefd9333eaf6c7301f0603551d23041830168014ab6d2e03b91d492240338fbccadefd9333eaf6c7300f0603551d130101ff040530030101ff302c06096086480186f842010d041f161d4f70656e53534c2047656e657261746564204365727469666963617465300a06082a8648ce3d0403020348003045022009fd0cab97b03e78f64e74d7dcee88668c476a0afc5aa2cebffe07d3be772ea9022100da38abc98a080f49f24ffece1fffc8a6cdd5b2c0b5da8fc7b767ac3a95dcb83e59035fd81859035ab900066776657273696f6e63312e306f646967657374416c676f726974686d675348412d3235366c76616c756544696765737473b900026f6f72672e637573746f6d2e74657374a1005820f78b02ae285ad50f0543d45c0985a09ac8f021948da1c7fbf4194892a5877764716f72672e69736f2e31383031332e352e31ae0058203659fe5ac06f2092f8bb8e6457a9cacc289e335cacf863e777f37545369314960158209881b964f33d36fdd87fca84e3dae3868cae405216f8ab499ba3b8b9b61cf6a8025820c42062a2ce0c68c7f316a4c625bd20946d3acd1f49b95d6e210fa01b6541e782035820b404e27767d66eda5744260d3f385e952f9092dfed012cc4434fd0abd7f9b06d045820d05d33268617cd4cedfceb4295f29ab8ac237cb1a6b03b3a113b3390a9c549f9055820f1bd9a2f74be31880231c9a52b215ff38e736acc1190f2f46669551a8d793c35065820e02df0407ceeee151fc4572aa37824c228b86623ce7d2550ae96bad1855c634c075820655c6f8e3e31b79e288f6b815f65bb5f8de17484aba0f31ad8427bc0b93bb5550858205d5d5c441b07802de0a355576d1545458c7519778982955dce552930951e4743095820aac192504c7bcc55f0ce82407df7fce71ace7cd360477efe17c7b0ac7b660c400a58206e41d0fe61717ecf970261b10b8f608010862199c13828a1fee7100cf2865a4b0b58208654d131837036322c4ce4cec296e51bf665351cb9a910b64ac53798f0a2e9be0c582027d8d339a308b8f6bd00069e6fbe79ae027f9e1909eed75cbbc8d4fd4fc29d0b0d5820b45fd1323c6902bb680aedbc22bcc4a7d87d3cfb19502ec551fd2e2dede419c86d6465766963654b6579496e666fb90001696465766963654b6579a40102215820881879ca7a238b19bf0f4c1f8c00e9a2e19ba7a6f73eae92b851d4de1b508559225820a314b538039127b5cd50735f54519e33c134450545c5603ad9f263facc56d377200167646f6354797065756f72672e69736f2e31383031332e352e312e6d444c6c76616c6964697479496e666fb90003667369676e6564c074323032332d31302d31385431363a30303a32345a6976616c696446726f6dc074323032332d31302d31385431363a30303a32345a6a76616c6964556e74696cc074323032372d31302d31385431363a30303a32345a58404581f12205d8cf13f369ef68fe05b72cdaa5b61191eaa179c53c54608a9a07d34fac15b7b7eac7f7881d9e640f4e9c842c7cd547f6ec8e11b7da26246e78e4b66673746174757300`;
    parsed = parse(mdoc);
  });

  it('should match the snapshot', () => {
    expect(parsed).toMatchSnapshot();
  });

  it('should contain the given name', () => {
    const givenName = parsed.documents[0]?.issuerSigned.nameSpaces[
      'org.iso.18013.5.1'
    ]?.find(e => e.elementIdentifier === 'given_name')?.elementValue;
    expect(givenName).toBe('John');
  });

  it('should return an undefined deviceSigned attribute', () => {
    // @ts-expect-error deviceSigned is not defined
    expect(parsed.documents[0]?.deviceSigned).toBeUndefined();
  });
});
